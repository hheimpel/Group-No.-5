---
title: "Impact of Financial Access on School Attendance"
author: "Group No. 5"
date: "February 11, 2019"
output: pdf_document
fontsize: 12pt
documentclass: article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
```
```{r, cache=TRUE}
require("recipes")
require("haven")
library("here")
require("tidyverse")
require("readxl")
require("pdp")
require("caret")
```

\textbf{Members:}\
\begin{itemize}
  \itemsep-.6em
  \item Hector Hernandez Heimpel (NetID: hh744) - email: hh744@georgetown.edu\
  \item Tingjie  Meng (NetID: tm1305) - email: tm1305@georgetown.edu\
  \item Liumin Chen (NetID: lc1077) - email: lc1077@georgetown.edu\
\end{itemize}
\textbf{Github Repository:} https://github.com/hheimpel/Group-No.-5 

\section{Problem Statement}

Education has long been considered important to economic growth. The general idea behind this is that people with higher education have higher income, as evidenced by Ashenfelter (1997). There are many factors that could affect why a child attends or does not attend school. In particular, financial access could affect schooling through access to credit and savings with better conditions. By limiting the incentives and capacity to invest in human capital, credit
constraints play an important role in determining aggregate productivity, national income distributions, social mobility, and economic growth and development Becker (1975). According to Aportela (1998) it was found that access to financial services increases savings on low-income people. What this could imply is that with better access to financial instruments that allow people to save money, a household head may better prepare for the expenses that will have to be made when the child goes to school. 

The question we seek to answer is if the mass introduction in 2002 of a bank (Banco Azteca) which offered new financial services to communities in Mexico which previously had no access to these particular banking services, affected the attendance to school of students in those communities. The intention of the project is to establish the relationship between attendance to school by children under 15 years of age and access to a banking service in Mexico. To establish the relationship we will make use of the appropriate econometric tools and empirical strategy. The relevance of this question is given by the likelihood of productivity being affected as well. Even if having access to banking services does not affect school attendance, the question would still be relevant to policy making since it could be a dimension for the decision of the policy maker.

\section{Data}

Our empirical strategy will be a difference in differences regression analysis for which we need panel data containing characteristics of mexican families in 2002, previous to the launch of Banco Azteca, and in 2005 after the launch of Banco Azteca; we will further need data detailing the municipalities where Banco Azteca opened branches. For this purpose, We will use two sources for our data. The first is the ENNVIH panel data which contains several characteristics of mexican families and is publicly available in the Mexican Family Life Survey website \footnote{http://www.ennvih-mxfls.org/english/ennvih-1.html}. The second dataset which contains the list of bank branches in different municipalities in Mexico at different points in time, including Banco Azteca, and is publicly available from the Comision Nacional Bancaria y de Valores (CBNV) website. \footnote{http://portafoliodeinformacion.cnbv.gob.mx/bm1/Paginas/infhistoriaoperativa.aspx}		
				
The data gathered from the Mexican Family Life Survey (MXFLS) website details several aspects of a Mexican Family displayed throughout different categorized books. Among these details of mexican families, several variables related to school attendance can be found. The Mexican Family Life Survey consists of several books of panel data which are divided into two major categories: household characteristics and individual characteristics. These categories are consequently subdivided into several books detailing different aspects, for example, control, economy, consumption, reproductive health among others. Within these particular books, there are different questionnaires fitting into each category. 
			
Since Banco Azteca started operations on several locations on December 2002, the basis for choosing the year of the dataset has to consider that a period before that is needed. The next dataset will be for the year 2005-2006 and the reason 2005- 2006 is chosen is because it is the next immediate dataset available. If datasets from later years were chosen, more things would likely need to be controlled for because other policies could have come into play.


\section{Potential Issues}

The data from the Mexican Family Life Survey is in .dta form, however this should not pose a significant problem to the overall project; some data tidying and arranging will have to be done but the information is easily accesible. On the other hand, data from the Comision Nacional Bancaria y de Valores is in .xls form and requires some editing and cleansing to tidy the data set. This should not pose a significant problem either since the data is easily accessible as well and once the datasets have been properly arranged, analysis should be relatively easy to perform..

\newpage

\section{References}

\begin{itemize}
  \itemsep0em
    \item Aportela, Fernando, \textit{Effects of Financial Access on Savings by Low-Income People}, Mimeo, MIT, 1998.
    \item Ashenfelter, Orley and Cecilia Rouse, \textit{Income, Schooling, and Ability: Evidence from a New Sample of Identical Twins}, Quarterly Journal of Economics, Vol. 113, p. 253-284, 1997.
    \item Becker, Gary, \textit{Human Capital}, 2nd ed., Columbia University Press, New York, NY, 1975.
\end{itemize}

##Loading the Household Level Data for 2002

We start by loading the control book for 2002 (M X F L S - Book C). This book contains several control characteristics at an individual level and at a household level. Within the book there are four pertinent data sets to be used:

1. `c_portad.dta`: contains the location of the households by State, Municipality and Locality. It further contains a variable indicating number of inhabitants in Locality. This is a Household level data set.
2. `c_cv.dta`: contains physical characteristics of the household (i.e. whether it has a cooking room, a telephone, etc.). This is a Household level data set.
3. `c_cvo.dta`: this data set extends the previous one with more physical characteristics of the households (i.e. the construcction materials, access to electricity, etc.). This is a household level data set.
4. `c_ls.dta`: it contains control characteristics such as income, level of education, gender, among others. This is an individual level data set.

```{r, echo=FALSE, cache=TRUE}
#2002 Household data
control_book <- read_dta(here("Data","hh02dta_bc","c_portad.dta"))
dwell_char <- read_dta(here("Data","hh02dta_bc","c_cv.dta"))
d_obs_char <- read_dta(here("Data","hh02dta_bc","c_cvo.dta"))
indiv_control_vars <- read_dta(here("Data","hh02dta_bc","c_ls.dta"))
```

###Removing non-informative variables in Book C
Once the data sets were loaded we proceeded to eliminate several non-informative variables. Some of them were redundant variables such as more identification characteristics for the household members, other variables seemed to ask the same thing but with a slightly different wording. For more details please check the Codebook for book C annexed in the project files.

```{r, cache=TRUE}
#Removing variables 
#indiv_control_vars
indiv_control_vars <- select(indiv_control_vars, -c(secuencia, ls00, ls02_1, ls12, ls03_1, ls03_21, ls03_22, ls06, ls07, ls08, ls11, ls13_1, ls15_1, ls16, ls18))

#control_book
control_book <- select(control_book, -c(ls, rel, reh, control, edad))
```
###Recoding variables in Household Level Data for 2002
The next step consisted of recoding the values of certain variables to reflect the different categories as the codebook instructed. The codebook provided numeric values to categorical variables which could be slightly confusing, we therefore recoded the values to reflect in a string what they actually meant. Additionally, we recoded dummy variables to be equal to one if the condition was true and zero otherwise (they were previously coded as threes as opposed to zeros); lastly, we created a resumed categorical variable for the size of the locality, if population was bigger thatn 100 thousand we categorized as `urban` and `rural` otherwise.

```{r, cache=TRUE}
#Recoding values for interpretation indiv_control_vars
#Gender
indiv_control_vars <- indiv_control_vars %>%
  mutate(ls04 = ifelse(ls04==1,"male",ifelse(ls04==3,"female",ls04)))

#Relationship to HH head
rel_HH_head <- c("HH_head", "Spouse/couple", "Son/daughter", "Step_son/daughter", "Son/daughter_in_law", "Father/Mother", "Father/Mother_in_law", "Brother/sister", "Brother/sister_in_law", "Grandkid", "Grandpa_ma", "Uncle/aunt", "Nephew/niece", "Cousin", "Worker", "Other")

for (i in 1:16) 
  {
  indiv_control_vars <- mutate(indiv_control_vars, ls05_1 = ifelse(ls05_1==i,rel_HH_head[i],ls05_1))
}

rm(rel_HH_head)

#Live in HH
indiv_control_vars <- mutate(indiv_control_vars, ls09=ifelse(ls09==3,0,ls09))

#Marital Status
marital <- c("Concubinage", "Separated", "Divorced", "Widowed", "Married", "Single")


for (j in 1:6) 
  {
  indiv_control_vars <- mutate(indiv_control_vars, ls10 = ifelse(ls10==j,marital[j],ls10))
}

rm(marital)
```
```{r, cache=TRUE}
#Control Book
control_book <- control_book %>%
  mutate(estrato=ifelse(estrato==1,"urban",ifelse(is.na(estrato),estrato,"rural")))
```
###Dropping variables with excessive missing values
In many of the books many missing values for certain variables were observed. We created a data frame per data se to show us how many missing values each variable had and kept only the variables which didn't have an excessive amount of missing values. The first data set we noticed a missing values problem was `c_cv` as the following results show:
```{r, cache=TRUE}
#d_obs_char missing values
d_obs_char_names <- names(d_obs_char)
miss_tib <- tibble()
for (x in d_obs_char_names) {
  mis <- sum(is.na(d_obs_char[,x]))
  mis_vals <- tibble(var=x,m_values=mis)
  miss_tib <- bind_rows(miss_tib, mis_vals)
 rm(mis)
 rm(mis_vals)
}
rm(d_obs_char_names)
miss_tib
```
The second data set where we applied the same logic was `c_cv`:

```{r, cache=TRUE}
#dwell_char missing values
dwell_names <- names(dwell_char)
miss_tib <- tibble()
for (x in dwell_names) {
  mis <- sum(is.na(dwell_char[,x]))
  mis_vals <- tibble(var=x,m_values=mis)
  miss_tib <- bind_rows(miss_tib, mis_vals)
 rm(mis)
 rm(mis_vals)
}
rm(dwell_names)
miss_tib
```

We remove the variables which have over forty percent of missing values in these data sets. 

```{r, cache=TRUE}
#Removing variables with many missing values 
#d_obs_char
d_obs_char <- select(d_obs_char, -c(cvo03a, cvo03b, cvo03c, cvo03d, cvo03e, cvo03f))

#dwell_char
dwell_char <- select(dwell_char, c(folio, cv01_1, cv02_1, cv05, cv06, cv07, cv08_1, cv12, cv16))
```

###Merging Household level data, recoding and transforming book C data
Once we kept the variables with no issues in all the data sets previously mentioned we merged the data sets into a master data set. It's important to mention that the merging was done by the variable `folio` which is the individual household id; by doing so, there were several household level characteristics which were attributed to an individual level. Observations of the households contruction materials for example will be the same for each individual member of the household. Finally, some recoding was done to as before to reflect the true categoreis of a variable with strings and dummies were appropriately transformed.

```{r, cache=TRUE}
#Merging
master_household2002 <- left_join(control_book, d_obs_char, by = c("folio"))
master_household2002 <- master_household2002 %>%
  left_join(., dwell_char, by = c("folio")) %>%
  left_join(indiv_control_vars,., by = c("folio")) 
colnames(master_household2002) <- c("hhid", "individual_id", "age", "gender", "hh_status", "live_in_hh", "marital_status", "hh_income", "education_level", "state", "municipality", "community", "urban", "id_loc", "type_hh", "electricity", "material_floor", "material_wall", "material_roof", "telephone", "property_status", "cook_room", "sleep_kitchen", "rooms_sleep", "source_water","same_drink_wash_water", "toilet")

#type_hh recode
type_hh_r <- c("Mobile dwelling", "Warehouse used as a dwelling", "Room loft 12", "Room or house in a vicinity", "Building apartment/Vertical dept", "Sole House sharing walls", "Sole house/does not share walls", "Other")

for (i in 1:8) 
  {
  master_household2002 <- mutate(master_household2002, type_hh = ifelse(type_hh==i,type_hh_r[i],type_hh))
}

rm(type_hh_r)

#material floor recode
material_floor_n <- c("Wood/slab stone/slab/carpet/covers", "Firm cement", "Soil", "Other")

for (i in 1:4) 
  {
  master_household2002 <- mutate(master_household2002, material_floor = ifelse(material_floor==i,material_floor_n[i],material_floor))
}

rm(material_floor_n)

#material wall recode

mwr <- c("Concrete partition,brick, block", "Adobe", "Wood", "Asbestos", "metallic plate, fiberglass, plastic", "Embarro or bajareque", "Reedgrass/bamboo/shingle","Cardboard sheets", "Residue material","Stone", "Other")

for (i in 1:10) 
  {
  master_household2002 <- mutate(master_household2002, material_wall = ifelse(material_wall==i,mwr[i],material_wall))
}

rm(mwr)

#material roof recode
mrr <- c("Polyurethane", "Concrete partition,brick, block", "Slate", "Asbestos", "bamboo", "metallic laminate", "Wood", "Cardboard", "Residue Material", "Other")

for (i in 1:10) 
  {
  master_household2002 <- mutate(master_household2002, material_roof = ifelse(material_roof==i,mrr[i],material_roof))
}

rm(mrr)

#Property Status
pss <- c("Currently paying it", "Your own and fully paid", "Your own ejido/community land", "Borrowed/ given without
payment", "Rented", "Other")

for (i in 1:6) 
  {
  master_household2002 <- mutate(master_household2002, property_status = ifelse(property_status==i,pss[i],property_status))
}

rm(pss)

#Source of water
wss <- c("Decanter", "Tap water inside", "Tap water outside", "Water from a truck", "gathered", "Other")

for (i in 1:6) 
  {
  master_household2002 <- mutate(master_household2002, source_water = ifelse(source_water==i,wss[i],source_water))
}

rm(wss)

#Dummies: Electricity, Telephone, cook_room, sleep_kitchen, same_drink_wash_water, toilet
master_household2002 <- master_household2002 %>%
  mutate(electricity=ifelse(electricity==3,0,electricity)) %>%
  mutate(telephone=ifelse(telephone==3,0,telephone)) %>%
  mutate(cook_room=ifelse(cook_room==3,0,cook_room)) %>%
  mutate(sleep_kitchen=ifelse(sleep_kitchen==3,0,sleep_kitchen)) %>%
  mutate(same_drink_wash_water=ifelse(same_drink_wash_water==3,0,same_drink_wash_water)) %>%
  mutate(toilet=ifelse(toilet==3,0,toilet))
```
It is worth mentioning the transformation of three individual level variables to household level variables. The first variable measured the highest education grade the household member had attended; since the focus will be children between 6 and 15 years of age we transformed the variable to show the average \textbf{adult} household member education. It seems likely that children whose accompanying adult household memberhave a higher education level will be more likely to have more education.

```{r, cache=TRUE}
#creating average household adult (older than 15) member education
hh_avg_educ <- tibble(hh_avg_ed = NA)
aux <- master_household2002 %>%
  cbind(.,hh_avg_educ) %>% 
  mutate(adult=ifelse(age>15,1,ifelse(15 >= age,0,age))) %>%
  filter(adult==1) %>%
  group_by(hhid, adult) %>%
  mutate(hh_avg_ed=mean(education_level, na.rm=TRUE),education_level) %>%
  ungroup(.) %>%
  select(c(hhid,hh_avg_ed)) %>%
  arrange(hhid,desc(hh_avg_ed)) %>%
  distinct(hhid, .keep_all =TRUE)

master_household2002 <- left_join(master_household2002,aux)
master_household2002 <- select(master_household2002,-c("education_level"))
rm(aux)
```
The second variable we transformed was income. Since income only reflected the individual level of income and since many children do not have income themselves we transformed the variable to show the average income per household. Intuitively, if the aggregated or average income per household is bigger then perhaps children have more opportunities to attend school. It would have seemed naive to impute missing values of income for children with things other than a household level transformation of the individual level variable income.
```{r, cache=TRUE}
#Household combined Income
master_household2002_1 <- master_household2002 %>%
  group_by(hhid) %>%
  summarise(hh_income = sum(hh_income, na.rm=TRUE))

master_household2002 <- master_household2002 %>%
  select(-c(hh_income)) %>%
  left_join(.,master_household2002_1, by=c("hhid"))
rm(master_household2002_1)
```
The third variable we transformed was relationship status. Since it is safe to assume that most children under 15 are single we decided to create a household level variable which reflected the relationship status of the household head. The intuition behind this is that perhaps there is some correlation between having married figures as parents or household heads.
```{r, cache=TRUE}
master_household2002_1 <- master_household2002 %>%
  filter(hh_status == "HH_head") %>%
  select(hhid, marital_status) %>%
  left_join(master_household2002,., by = c("hhid"))

master_household2002 <- select(master_household2002_1, -c("marital_status.x"))
```
Once we created all the household level transformations to the mentioned variables, we filtered the data to only include children older than 5 and younger than 15.
```{r, cache=TRUE}
master_household2002 <- filter(master_household2002, age>5, age<15)
rm(control_book,d_obs_char,dwell_char, hh_avg_educ,indiv_control_vars,master_household2002_1,miss_tib)
```
##Child Individual Data

We then proceeded to load individual level data for children by loading the book V for 2002 (M X F L S - Book V). This book contains several characteristics at an individual level for children under 15 yearsof age. Within the book there are six pertinent data sets to be used:

1. `v_edna.dta`: contains information regarding children's education.
2. `v_emn.dta`: contains information regarding child labor.
3. `v_cen.dta`: contains information regarding outpatient utilization for children.
4. `v_atn.dta`: contains information regarding time allocation for children.
5. `v_esn.dta`: contains information regarding overall children's health.
6. `v_hsn.dta`: contains information regarding inpatient utilization for children.

```{r, echo=FALSE, cache=TRUE}
#2002 Children under 15 data
ch_education <- read_dta(here("Data","hh02dta_b5","v_edna.dta"))
ch_employment <- read_dta(here("Data","hh02dta_b5","v_emn.dta"))
ch_outp_ut <- read_dta(here("Data","hh02dta_b5","v_cen.dta"))
ch_t_alloc <- read_dta(here("Data","hh02dta_b5","v_atn.dta"))
ch_health <- read_dta(here("Data","hh02dta_b5","v_esn.dta"))
ch_inp_ut <- read_dta(here("Data","hh02dta_b5","v_hsn.dta"))
```


###Exploring missing values
These data sets contained many varibles with excessive amounts of missing values. Once again we went through all data sets to identify variables which had excesssive amounts of missing values.
```{r, cache=TRUE}
#Missing values ch_education
ched_names <- names(ch_education)
miss_tib <- tibble()
for (x in ched_names) {
  mis <- sum(is.na(ch_education[,x]))
  mis_vals <- tibble(var=x,m_values=mis)
  miss_tib <- bind_rows(miss_tib, mis_vals)
 rm(mis)
 rm(mis_vals)
}
rm(ched_names)
miss_tib
```

```{r, cache=TRUE}
#Missing values ch_employment
ched_names <- names(ch_employment)
miss_tib <- tibble()
for (x in ched_names) {
  mis <- sum(is.na(ch_employment[,x]))
  mis_vals <- tibble(var=x,m_values=mis)
  miss_tib <- bind_rows(miss_tib, mis_vals)
 rm(mis)
 rm(mis_vals)
}
rm(ched_names)
miss_tib
```
```{r, cache=TRUE}
#Missing values ch_health
ched_names <- names(ch_health)
miss_tib <- tibble()
for (x in ched_names) {
  mis <- sum(is.na(ch_health[,x]))
  mis_vals <- tibble(var=x,m_values=mis)
  miss_tib <- bind_rows(miss_tib, mis_vals)
 rm(mis)
 rm(mis_vals)
}
rm(ched_names)
miss_tib
```
```{r, cache=TRUE}
#Missing values ch_t_alloc
ched_names <- names(ch_t_alloc)
miss_tib <- tibble()
for (x in ched_names) {
  mis <- sum(is.na(ch_t_alloc[,x]))
  mis_vals <- tibble(var=x,m_values=mis)
  miss_tib <- bind_rows(miss_tib, mis_vals)
 rm(mis)
 rm(mis_vals)
}
rm(ched_names)
miss_tib
```

###Recoding and merging to prepare master data set for children
Once we identified the variables with many missing values we then proceeded to discard redundant variables and to merge all of the data sets into a master data set. Categorical variables were also transformed to show the actual string category they represent as opposed to numeric value.
```{r, cache=TRUE}
#Removing redundant variables or with many missing values and renaming them
ch_education <- ch_education %>%
  select(folio,ls,edn01,edn01a,edn02,edn03)
colnames(ch_education) <- c("hhid","individual_id","indig_language","older_5","s_spanish","attend_school")

ch_employment <- ch_employment %>%
  select(folio,ls,emn01a,emn02,emn04)
colnames(ch_employment) <- c("hhid", "individual_id", "work_1hr", "work_fam_bus", "work_ever")

ch_health <- ch_health %>%
  select(folio,ls,esn01)
colnames(ch_health) <- c("hhid", "individual_id", "health_level")

ch_outp_ut <- ch_outp_ut %>%
  select(folio,ls,cen01)
colnames(ch_outp_ut) <- c("hhid", "individual_id", "doctor_visit")

ch_inp_ut <- ch_inp_ut %>%
  select(folio,ls,hsn01)
colnames(ch_inp_ut) <- c("hhid", "individual_id", "hospitalized")

ch_t_alloc <- ch_t_alloc %>%
  select(folio, ls, atn01a:atn01i, atn03)
colnames(ch_t_alloc) <- c("hhid", "individual_id", "cult_act", "lessons", "watch_tv", "domestic_hwork", "play_outside", "care_elderly", "carried_firewood", "carried_water", "agric_activity", "hours_sleep")

#Merging data sets
child_master2002 <- left_join(ch_education,ch_employment, by = c("hhid","individual_id")) 
child_master2002 <- child_master2002 %>%
  left_join(.,ch_health, by = c("hhid","individual_id")) %>%
  left_join(.,ch_inp_ut, by = c("hhid","individual_id")) %>%
  left_join(.,ch_outp_ut, by = c("hhid","individual_id")) %>%
  left_join(.,ch_t_alloc, by = c("hhid", "individual_id"))
```
###Recoding dummies
The last step consisted of recoding dummy variables to have a value of one if condition was true and zero otherwise.
```{r, cache=TRUE}
dummies_ch <- names(child_master2002)
dummies_ch <- dummies_ch[c(3:9, 11:22)]
for (x in dummies_ch) {
  x1 <- as.name(x)
  child_master2002 <- mutate(child_master2002, !! x1 := ifelse(!! x1 == 3 | !!x1 == 2,0,!! x1))
}
```
```{r, cache=TRUE}
child_master2002 <- filter(child_master2002, older_5==1) %>%
  select(-c(older_5))
rm(ch_education,ch_employment,ch_health,ch_inp_ut,ch_outp_ut,ch_t_alloc,miss_tib)
```
##Merging Book V and Book C master data sets

To have the working master data set we merge both of the master data sets from book C and book V.

```{r, cache=TRUE}
master_2002 <- left_join(child_master2002,master_household2002, by = c("hhid", "individual_id")) %>%
  select(-c(live_in_hh))
rm(master_household2002,child_master2002)
```
And finally, we impute household level missing variables (missing observations at a household level will be substituted for whichever value or characteristic other members of the household have).

```{r, cache=TRUE}
Mode <- function(x) {
  ux <- unique(x) 
  ux[which.max(tabulate(match(x, ux)))]
}

aux <- c("state", "municipality", "community", "urban", "id_loc", "type_hh", "electricity", "material_floor", "material_wall", "material_roof", "telephone", "property_status", "cook_room", "sleep_kitchen", "rooms_sleep", "source_water","same_drink_wash_water", "toilet", "hh_avg_ed",  "hh_income", "marital_status.y")

master_2002 <- group_by(master_2002, by = hhid)

for (x in aux) {
x1 <- as.name(x)
  master_2002 <- mutate(master_2002, !! x1 := ifelse(is.na(!! x1), Mode(!! x1), !! x1)) 
}

master_2002 <- ungroup(master_2002) %>%
  select(-c(by))
rm(aux)
```

#CREATING DATA SET FOR 2005

```{r, echo=FALSE, cache=TRUE}
#2005 Household data
control_book <- read_dta(here("Data","hh05dta_bc","c_portad.dta"))
dwell_char <- read_dta(here("Data","hh05dta_bc","c_cv.dta"))
d_obs_char <- read_dta(here("Data","hh05dta_bc","c_cvo.dta"))
indiv_control_vars <- read_dta(here("Data","hh05dta_bc","c_ls.dta"))

#Removing variables 
#indiv_control_vars
indiv_control_vars <- select(indiv_control_vars, c(folio, ls, ls02_2, ls04, ls05_1, ls10, ls13_2, ls14))

#control_book
control_book <- select(control_book, -c(ls, catorcena, rel, reh, control, edad))

#Recoding values for interpretation indiv_control_vars
#Gender
indiv_control_vars <- indiv_control_vars %>%
  mutate(ls04 = ifelse(ls04==1,"male",ifelse(ls04==3,"female",ls04)))

#Relationship to HH head
rel_HH_head <- c("HH_head", "Spouse/couple", "Son/daughter", "Step_son/daughter", "Son/daughter_in_law", "Father/Mother", "Father/Mother_in_law", "Brother/sister", "Brother/sister_in_law", "Grandkid", "Grandpa_ma", "Uncle/aunt", "Nephew/niece", "Cousin", "Worker", "Other")

for (i in 1:16) 
  {
  indiv_control_vars <- mutate(indiv_control_vars, ls05_1 = ifelse(ls05_1==i,rel_HH_head[i],ls05_1))
}

rm(rel_HH_head)

#Marital Status
marital <- c("Concubinage", "Separated", "Divorced", "Widowed", "Married", "Single")


for (j in 1:6) 
  {
  indiv_control_vars <- mutate(indiv_control_vars, ls10 = ifelse(ls10==j,marital[j],ls10))
}

rm(marital)

#Control Book
control_book <- control_book %>%
  mutate(estrato=ifelse(estrato==1,"urban",ifelse(is.na(estrato),estrato,"rural")))

#Removing variables with many missing values 
#d_obs_char
d_obs_char <- select(d_obs_char, -c(cvo03a, cvo03b, cvo03c, cvo03d, cvo03e, cvo03f))

#dwell_char
dwell_char <- select(dwell_char, c(folio, cv01_1, cv02_1, cv05, cv06, cv07, cv08_1, cv12, cv16))

#Merging
master_household2002 <- left_join(control_book, d_obs_char, by = c("folio"))
master_household2002 <- master_household2002 %>%
  left_join(., dwell_char, by = c("folio")) %>%
  left_join(indiv_control_vars,., by = c("folio")) 
colnames(master_household2002) <- c("hhid", "individual_id", "age", "gender", "hh_status", "marital_status", "hh_income", "education_level", "state", "urban", "locality", "id_loc", "municipality", "type_hh", "electricity", "material_floor", "material_wall", "material_roof", "telephone", "property_status", "cook_room", "sleep_kitchen", "rooms_sleep", "source_water","same_drink_wash_water", "toilet")

#type_hh recode
type_hh_r <- c("Mobile dwelling", "Warehouse used as a dwelling", "Room loft 12", "Room or house in a vicinity", "Building apartment/Vertical dept", "Sole House sharing walls", "Sole house/does not share walls", "Other")

for (i in 1:8) 
  {
  master_household2002 <- mutate(master_household2002, type_hh = ifelse(type_hh==i,type_hh_r[i],type_hh))
}

rm(type_hh_r)

#material floor recode
material_floor_n <- c("Wood/slab stone/slab/carpet/covers", "Firm cement", "Soil", "Other")

for (i in 1:4) 
  {
  master_household2002 <- mutate(master_household2002, material_floor = ifelse(material_floor==i,material_floor_n[i],material_floor))
}

rm(material_floor_n)

#material wall recode

mwr <- c("Concrete partition,brick, block", "Adobe", "Wood", "Asbestos", "metallic plate, fiberglass, plastic", "Embarro or bajareque", "Reedgrass/bamboo/shingle","Cardboard sheets", "Residue material","Stone", "Other")

for (i in 1:10) 
  {
  master_household2002 <- mutate(master_household2002, material_wall = ifelse(material_wall==i,mwr[i],material_wall))
}

rm(mwr)

#material roof recode
mrr <- c("Polyurethane", "Concrete partition,brick, block", "Slate", "Asbestos", "bamboo", "metallic laminate", "Wood", "Cardboard", "Residue Material", "Other")

for (i in 1:10) 
  {
  master_household2002 <- mutate(master_household2002, material_roof = ifelse(material_roof==i,mrr[i],material_roof))
}

rm(mrr)

#Property Status
pss <- c("Currently paying it", "Your own and fully paid", "Your own ejido/community land", "Borrowed/ given without
payment", "Rented", "Other")

for (i in 1:6) 
  {
  master_household2002 <- mutate(master_household2002, property_status = ifelse(property_status==i,pss[i],property_status))
}

rm(pss)

#Source of water
wss <- c("Decanter", "Tap water inside", "Tap water outside", "Water from a truck", "gathered", "Other")

for (i in 1:6) 
  {
  master_household2002 <- mutate(master_household2002, source_water = ifelse(source_water==i,wss[i],source_water))
}

rm(wss)

#Dummies: Electricity, Telephone, cook_room, sleep_kitchen, same_drink_wash_water, toilet
master_household2002 <- master_household2002 %>%
  mutate(electricity=ifelse(electricity==3,0,electricity)) %>%
  mutate(telephone=ifelse(telephone==3,0,telephone)) %>%
  mutate(cook_room=ifelse(cook_room==3,0,cook_room)) %>%
  mutate(sleep_kitchen=ifelse(sleep_kitchen==3,0,sleep_kitchen)) %>%
  mutate(same_drink_wash_water=ifelse(same_drink_wash_water==3,0,same_drink_wash_water)) %>%
  mutate(toilet=ifelse(toilet==3,0,toilet))

#creating average household adult (older than 15) member education
hh_avg_educ <- tibble(hh_avg_ed = NA)
aux <- master_household2002 %>%
  cbind(.,hh_avg_educ) %>% 
  mutate(adult=ifelse(age>15,1,ifelse(15 >= age,0,age))) %>%
  filter(adult==1) %>%
  group_by(hhid, adult) %>%
  mutate(hh_avg_ed=mean(education_level, na.rm=TRUE),education_level) %>%
  ungroup(.) %>%
  select(c(hhid,hh_avg_ed)) %>%
  arrange(hhid,desc(hh_avg_ed)) %>%
  distinct(hhid, .keep_all =TRUE)

master_household2002 <- left_join(master_household2002,aux)
master_household2002 <- select(master_household2002,-c("education_level"))
rm(aux)

#Household combined Income
master_household2002_1 <- master_household2002 %>%
  group_by(hhid) %>%
  summarise(hh_income = sum(hh_income, na.rm=TRUE))

master_household2002 <- master_household2002 %>%
  select(-c(hh_income)) %>%
  left_join(.,master_household2002_1, by=c("hhid"))
rm(master_household2002_1)

master_household2002_1 <- master_household2002 %>%
  filter(hh_status == "HH_head") %>%
  select(hhid, marital_status) %>%
  left_join(master_household2002,., by = c("hhid"))

master_household2002 <- select(master_household2002_1, -c("marital_status.x"))

master_household2002 <- filter(master_household2002, age>5, age<15)
rm(control_book,d_obs_char,dwell_char, hh_avg_educ,indiv_control_vars,master_household2002_1,miss_tib)

#2002 Children under 15 data
ch_education <- read_dta(here("Data","hh02dta_b5","v_edna.dta"))
ch_employment <- read_dta(here("Data","hh02dta_b5","v_emn.dta"))
ch_outp_ut <- read_dta(here("Data","hh02dta_b5","v_cen.dta"))
ch_t_alloc <- read_dta(here("Data","hh02dta_b5","v_atn.dta"))
ch_health <- read_dta(here("Data","hh02dta_b5","v_esn.dta"))
ch_inp_ut <- read_dta(here("Data","hh02dta_b5","v_hsn.dta"))

#Removing redundant variables or with many missing values and renaming them
ch_education <- ch_education %>%
  select(folio,ls,edn01,edn01a,edn02,edn03)
colnames(ch_education) <- c("hhid","individual_id","indig_language","older_5","s_spanish","attend_school")

ch_employment <- ch_employment %>%
  select(folio,ls,emn01a,emn02,emn04)
colnames(ch_employment) <- c("hhid", "individual_id", "work_1hr", "work_fam_bus", "work_ever")

ch_health <- ch_health %>%
  select(folio,ls,esn01)
colnames(ch_health) <- c("hhid", "individual_id", "health_level")

ch_outp_ut <- ch_outp_ut %>%
  select(folio,ls,cen01)
colnames(ch_outp_ut) <- c("hhid", "individual_id", "doctor_visit")

ch_inp_ut <- ch_inp_ut %>%
  select(folio,ls,hsn01)
colnames(ch_inp_ut) <- c("hhid", "individual_id", "hospitalized")

ch_t_alloc <- ch_t_alloc %>%
  select(folio, ls, atn01a:atn01i, atn03)
colnames(ch_t_alloc) <- c("hhid", "individual_id", "cult_act", "lessons", "watch_tv", "domestic_hwork", "play_outside", "care_elderly", "carried_firewood", "carried_water", "agric_activity", "hours_sleep")

#Merging data sets
child_master2002 <- left_join(ch_education,ch_employment, by = c("hhid","individual_id")) 
child_master2002 <- child_master2002 %>%
  left_join(.,ch_health, by = c("hhid","individual_id")) %>%
  left_join(.,ch_inp_ut, by = c("hhid","individual_id")) %>%
  left_join(.,ch_outp_ut, by = c("hhid","individual_id")) %>%
  left_join(.,ch_t_alloc, by = c("hhid", "individual_id"))

dummies_ch <- names(child_master2002)
dummies_ch <- dummies_ch[c(3:9, 11:22)]
for (x in dummies_ch) {
  x1 <- as.name(x)
  child_master2002 <- mutate(child_master2002, !! x1 := ifelse(!! x1 == 3 | !!x1 == 2,0,!! x1))
}

child_master2002 <- filter(child_master2002, older_5==1) %>%
  select(-c(older_5))
rm(ch_education,ch_employment,ch_health,ch_inp_ut,ch_outp_ut,ch_t_alloc,miss_tib)

master_household2002 <- master_household2002 %>%
  mutate(hhid = as.numeric(hhid)) %>%
  mutate(individual_id = as.numeric(individual_id))

master_2005 <- left_join(child_master2002,master_household2002, by = c("hhid", "individual_id"))
rm(master_household2002,child_master2002)

aux <- c("state", "urban", "locality", "id_loc", "municipality", "type_hh", "electricity", "material_floor", "material_wall", "material_roof", "telephone", "property_status", "cook_room", "sleep_kitchen", "rooms_sleep", "source_water","same_drink_wash_water", "toilet", "hh_avg_ed",  "hh_income", "marital_status.y")

Mode <- function(x) {
  ux <- unique(x) 
  ux[which.max(tabulate(match(x, ux)))]
}

master_2005 <- group_by(master_2005, by = hhid)

for (x in aux) {
x1 <- as.name(x)
  master_2005 <- mutate(master_2005, !! x1 := ifelse(is.na(!! x1), Mode(!! x1), !! x1)) 
}

master_2005 <- ungroup(master_2005) %>%
  select(-c(by))
rm(aux)
```

##THE FOLLOWING IS NOT READY, WE HAVE TO SEE IF IT'S WORTH IT

```{r, echo=FALSE, cache=TRUE}
#Sucursales Azteca
azteca_2002 <- read_xls(here("Data","BM_Operativa_200212.xls"))
```

```{r, cache=TRUE}
#Municipalities names and codes
mpios <- read_xlsx(here("Data","Relacion_de_municipios_de_Mexico.xlsx"))

#Removing accents (so we can merge)
colnames(mpios) <- c("mpio","mpio_str")
mpios$mpio_str <- iconv(mpios$mpio_str, from = 'UTF-8', to = 'ASCII//TRANSLIT')

#Adding edo_str column
mpios <- mpios %>%
  rbind(c(NA,"AGUASCALIENTES"),.) %>%
  mutate(.,edo_str=NA)
for (i in 1:nrow(mpios)) {
  if (is.na(mpios$mpio[i])) {
    mpios$edo_str[i]=mpios$mpio_str[i]
  }else{
    mpios$edo_str[i]=mpios$edo_str[i-1]
  }
}
```
```{r, cache=TRUE}
#Preparing and cleaning azteca 2002 data
azteca_2002 <- select(azteca_2002,c(1:3,5:36))
aux <- c()
  for (i in 1:35) {
    aux[i] = azteca_2002[1,i]
  }
aux[[1]] <- "edo_str"
aux[[2]] <- "munic_cnbv_code"
aux[[3]] <- "mpio_str"
colnames(azteca_2002) <- aux
```
```{r, cache=TRUE}
#Dropping observations with missing location
azteca_2002 <- azteca_2002 %>%
  filter(., !is.na(munic_cnbv_code))

#Filling State missing values
for (i in 1:783) {
  if (is.na(azteca_2002[i,"edo_str"])) {
    azteca_2002[i,"edo_str"]=azteca_2002[i-1,"edo_str"]
    }else{
      i
  }
}

azteca_2002 <- filter(azteca_2002, edo_str!="Estado")
```
```{r, cache=TRUE}
#Creating States Data Frame with number identification (per codebook instructions)
by_edo_azt02 <- group_by(azteca_2002,edo_str)
by_edo_azt02 <- summarise(by_edo_azt02, sum=mean(BANAMEX, na.rm=TRUE)) %>%
  select(.,"edo_str") %>%
  mutate(.,edo=NA)
by_edo_azt02[3,2]=3
by_edo_azt02[7,2]=5
by_edo_azt02[9,2]=9
by_edo_azt02[10,2]=10
by_edo_azt02[11,2]=11
by_edo_azt02[14,2]=14
by_edo_azt02[15,2]=15
by_edo_azt02[16,2]=16
by_edo_azt02[17,2]=17
by_edo_azt02[18,2]=19
by_edo_azt02[19,2]=20
by_edo_azt02[20,2]=21
by_edo_azt02[24,2]=25
by_edo_azt02[25,2]=26
by_edo_azt02[30,2]=30
by_edo_azt02[31,2]=31


#Merging states number identification with azteca_2002
azteca_2002 <- left_join(azteca_2002,by_edo_azt02,by="edo_str")

#Merging Municipalities
by_edo_azt02CAPS <- by_edo_azt02
by_edo_azt02CAPS <- mutate(by_edo_azt02CAPS,edo_str=toupper(edo_str))
by_edo_azt02CAPS$edo_str <- iconv(by_edo_azt02CAPS$edo_str, from = 'UTF-8', to = 'ASCII//TRANSLIT')
by_edo_azt02CAPS[9,1]="CIUDAD DE MEXICO"
by_edo_azt02CAPS[7,1]="COAHULIA"
by_edo_azt02CAPS[15,1]="ESTADO DE MEXICO"
mpios <- mpios %>% 
  left_join(.,by_edo_azt02CAPS,by="edo_str") %>%
  select(.,mpio,mpio_str,edo)
azteca_2002 <- inner_join(azteca_2002,mpios,by=c("mpio_str","edo"))
azteca_2002 <- filter(azteca_2002,edo!=is.na(edo), mpio!=is.na(mpio))
```
```{r, cache=TRUE}
#Renaming variables
colnames(azteca_2002) <- c("edo_str","munic_cnbv_code","mpio_str","amex","banamex","afirme","mifel","bancen","azteca","bajio","inbursa","interacciones","invex","monex","santander","dresdner","boston","america","tokio_ufj","one","banorte","banregio","bansi","bancomer","credit_suisse","deutsche_bank","ge","republic","bital","ing","ixe","jp_morgan","scotiabank","serfin","royal_bank_scotland","edo","mpio")

azteca_2002 <- select(azteca_2002, "edo_str","edo","mpio_str","mpio","amex","banamex","afirme","mifel","bancen","azteca","bajio","inbursa","interacciones","invex","monex","santander","dresdner","boston","america","tokio_ufj","one","banorte","banregio","bansi","bancomer","credit_suisse","deutsche_bank","ge","republic","bital","ing","ixe","jp_morgan","scotiabank","serfin","royal_bank_scotland")

#Dropping if missing state (since they won't be in ENNVIH data sets)
azteca_2002 <- filter(azteca_2002, edo!=is.na(edo))
```
```{r, cache=TRUE}
#Changing digit strings to numeric
azt_numvar_names <- c("edo","mpio","amex","banamex","afirme","mifel","bancen","azteca","bajio","inbursa","interacciones","invex","monex","santander","dresdner","boston","america","tokio_ufj","one","banorte","banregio","bansi","bancomer","credit_suisse","deutsche_bank","ge","republic","bital","ing","ixe","jp_morgan","scotiabank","serfin","royal_bank_scotland")
for (x in azt_numvar_names) {
  azteca_2002 <- azteca_2002 %>% mutate_(.dots=setNames(paste0("as.double(",x,")"), x))
}
```
```{r, cache=TRUE}
#replacing missing values with zero
for (x in azt_numvar_names) {
  azteca_2002 <- azteca_2002 %>% mutate_(.dots=setNames(paste0("ifelse(is.na(",x,"),0,",x,")"),x))
}
```




